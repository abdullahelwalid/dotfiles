#!/usr/bin/env bash

# Geotags image files in input directory using GPX tracks uploaded to
# iCloud by https://itunes.apple.com/gb/app/geotag-photos-pro-2/id1008694552?mt=8

# The timezone offset is how much to add to the camera time to get to
# GPS time. (Actual time zones are not really supported by cameras, so
# we need to do this hack...)

# It's safe to run this command multiple times until the geotags match
# up with reality; exiftool writes separate "GPS" time stamps to the
# metadata, while leaving the original times alone. Use "exiftool
# -time:all" to view all time metadata.

EXIFTOOL=exiftool
GPXDIR="$HOME/Library/Mobile Documents/iCloud~com~tappytaps~geotagphotos2/Documents"

if [ $# -eq 0 ]; then
  echo "usage: $(basename $0) dir [+-hh:mm:ss] # google: [time difference utc miami] http://bit.ly/2wkvvhF"
  exit 1
fi  

if ! which -s "$EXIFTOOL" ; then
  echo "error: [$EXIFTOOL] not found"
  exit 1
fi

if ! test -d "$GPXDIR" ; then
  echo "error: [$GPXDIR] not found"
fi

if ! test -d "$1" ; then
  echo "error: [$1] is not a directory"
  exit 1
fi

if test -n "$2" ; then
  exiftool -overwrite_original -geotag "$GPXDIR/*.gpx" -geosync="$2" "$1"
else
  exiftool -overwrite_original -geotag "$GPXDIR/*.gpx" "$1"
fi
