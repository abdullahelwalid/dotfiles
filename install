#!/usr/bin/env bash

# Symlinks files stored in $HOME/.config (i.e. in a subversion repository)
# to their correct location--mostly $HOME, but a few other directories
# as well, like $HOME/.subversion/config.
#
# This command is idempotent; you can safely run it more than once.

CONFIGROOT=${1:-$HOME/.config}

if [ ! -d "$CONFIGROOT/home" ]; then
  echo "error: $CONFIGROOT does not exist"
  echo "usage: $0 [config_dir]"
  echo "example: $0 \`pwd\`"
  exit
fi

# 1. Runs the passed command.
# 2. Echos the executed command.

function x {

  "$@"

  while [ "$1" ]; do

    if [[ "$1" =~ " " ]]; then
      echo -n "'$1'"
    else 
      echo -n "$1"
    fi

    if [ ! -z "$2" ]; then
      echo -n " "
    else
      echo
    fi

    shift

  done

}

for f in gls ls ; do

  if [ -x "$(which $f)" ]; then
     LS=$f
     break
  fi

done

cd "$CONFIGROOT/home"

for f in `$LS -AB` ; do # substitution not supported with the $(...) style

  if [ "$f" = "CVS" ]; then
    continue
  fi

  if [ "$f" = ".svn" ]; then
    continue
  fi
  
  if [ "$f" = ".git" ]; then
    continue
  fi
  
  if [[ "$f" =~ "~$" ]]; then
    continue
  fi
  
  x ln -sf "${CONFIGROOT#$HOME/}/home/$f" "$HOME"

done

if [ `which svn` ]; then
  x rm -f "$HOME/.subversion/config"
  x mkdir -p "$HOME/.subversion"
  x ln -sf "$CONFIGROOT/etc/subversion/config" "$HOME/.subversion/config"
fi

if [ `which cpan` ]; then  
  x rm -f "$HOME/.cpan/CPAN/MyConfig.pm"
  x mkdir -p "$HOME/.cpan/CPAN"
  x ln -sf "$CONFIGROOT/etc/CPAN/MyConfig.pm" "$HOME/.cpan/CPAN/MyConfig.pm"
fi

if [ `which subl` ]; then

  if [ `$HOME/.platform` = "linux" ]; then
    DST="$HOME/.config/sublime-text-2/Packages/User"
  else
    DST="$HOME/Library/Application Support/Sublime Text 2/Packages/User"
  fi
  
  echo "dst = $DST"
    
  x mkdir -p "$DST"
  x rm -f "$DST/Base File.sublime-settings"
  x ln -sf "$CONFIGROOT/etc/subl/Base File.sublime-settings" "$DST/Base File.sublime-settings"
  x rm -f "$DST/Global.sublime-settings"
  x ln -sf "$CONFIGROOT/etc/subl/Global.sublime-settings" "$DST/Global.sublime-settings"
  
fi

if [ -d $HOME/Library ]; then

  x rm -f "$HOME/Library/KeyBindings"
  x ln -sf "$CONFIGROOT/etc/KeyBindings" "$HOME/Library/KeyBindings"

fi